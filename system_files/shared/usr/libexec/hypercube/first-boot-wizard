#!/bin/bash
# Hypercube First Boot Wizard Launcher
# Launches the graphical quickshell welcome wizard for user creation
# SPDX-License-Identifier: GPL-3.0-or-later

set -euo pipefail

# Check if any regular users exist (UID >= 1000)
if getent passwd | awk -F: '$3 >= 1000 && $3 < 65534 {exit 1}'; then
    # No regular users exist, run the wizard
    :
else
    # Users already exist, disable this service and exit
    systemctl disable hypercube-first-boot.service 2>/dev/null || true
    exit 0
fi

# Start a minimal Hyprland session for the wizard
# This runs before greetd, so we need to start our own compositor

# Create a temporary Hyprland config for the wizard
WIZARD_CONFIG=$(mktemp)
cat > "$WIZARD_CONFIG" << 'EOF'
# Minimal Hyprland config for first-boot wizard
monitor=,preferred,auto,1

input {
    kb_layout = us
    follow_mouse = 1
    touchpad {
        natural_scroll = yes
    }
}

general {
    gaps_in = 0
    gaps_out = 0
    border_size = 0
}

decoration {
    rounding = 0
    blur {
        enabled = false
    }
}

animations {
    enabled = no
}

# Start quickshell in welcome mode
exec-once = quickshell -c /etc/hypercube/quickshell/welcome-mode.qml

# Auto-exit when wizard completes
exec-once = sleep 1 && while pgrep -x quickshell > /dev/null; do sleep 1; done && hyprctl dispatch exit
EOF

# Set up the display
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=Hyprland
export XDG_SESSION_DESKTOP=Hyprland

# Run Hyprland with the wizard config
# This will block until the wizard is complete
Hyprland -c "$WIZARD_CONFIG" 2>/dev/null || true

# Clean up
rm -f "$WIZARD_CONFIG"

# Disable this service so it doesn't run again
systemctl disable hypercube-first-boot.service 2>/dev/null || true

exit 0
