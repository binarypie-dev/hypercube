# Neovim Podman Development Environment
# Run `just --list` to see available commands

image_name := "nvim-dev"
config_dir := env_var("HOME") / ".config/nvim"
data_dir := env_var("HOME") / ".local/share/nvim"
state_dir := env_var("HOME") / ".local/state/nvim"
cache_dir := env_var("HOME") / ".cache/nvim"

# Default recipe - show help
default:
    @just --list

# Build the Podman image (uses layer cache)
build:
    @echo "Building {{image_name}} image..."
    podman build -t {{image_name}} .
    @echo "✓ Image {{image_name}} built successfully"

# Force rebuild from scratch (no cache)
rebuild:
    @echo "Building {{image_name}} image (no cache)..."
    podman build --no-cache -t {{image_name}} .
    @echo "✓ Image {{image_name}} rebuilt successfully"

# Full clean rebuild (removes old image first, no cache)
rebuild-clean:
    @echo "Removing existing {{image_name}} image..."
    -podman rmi -f {{image_name}} 2>/dev/null
    @echo "Building fresh {{image_name}} image..."
    podman build --no-cache -t {{image_name}} .
    @echo "✓ Image {{image_name}} rebuilt successfully"

# Run nvim in current directory
run *args:
    @mkdir -p "{{data_dir}}" "{{state_dir}}" "{{cache_dir}}"
    podman run -it --rm \
        --name "nvim-$PPID" \
        --userns=keep-id \
        -e "TERM=${TERM:-xterm-256color}" \
        -e "COLORTERM=${COLORTERM:-truecolor}" \
        -v "{{config_dir}}:/home/nvim/.config/nvim:ro,z" \
        -v "{{data_dir}}:/home/nvim/.local/share/nvim:z" \
        -v "{{state_dir}}:/home/nvim/.local/state/nvim:z" \
        -v "{{cache_dir}}:/home/nvim/.cache/nvim:z" \
        -v "$(pwd):/home/nvim/workspace:z" \
        -w "/home/nvim/workspace" \
        {{image_name}} {{args}}

# Run a shell inside the container (for debugging)
shell:
    @mkdir -p "{{data_dir}}" "{{state_dir}}" "{{cache_dir}}"
    podman run -it --rm \
        --name "nvim-shell-$PPID" \
        --userns=keep-id \
        --entrypoint /bin/bash \
        -e "TERM=${TERM:-xterm-256color}" \
        -e "COLORTERM=${COLORTERM:-truecolor}" \
        -v "{{config_dir}}:/home/nvim/.config/nvim:ro,z" \
        -v "{{data_dir}}:/home/nvim/.local/share/nvim:z" \
        -v "{{state_dir}}:/home/nvim/.local/state/nvim:z" \
        -v "{{cache_dir}}:/home/nvim/.cache/nvim:z" \
        -v "$(pwd):/home/nvim/workspace:z" \
        -w "/home/nvim/workspace" \
        {{image_name}}

# Show image info
info:
    @podman image inspect {{image_name}} --format '{{{{.Id}}}}' 2>/dev/null && \
        echo "Image: {{image_name}}" && \
        podman image inspect {{image_name}} --format 'Created: {{{{.Created}}}}' && \
        podman image inspect {{image_name}} --format 'Size: {{{{.Size}}}}' | awk '{printf "Size: %.2f GB\n", $2/1024/1024/1024}' \
    || echo "Image {{image_name}} not found. Run 'just build' to create it."

# Remove the image
clean:
    @echo "Removing {{image_name}} image..."
    -podman rmi -f {{image_name}} 2>/dev/null
    @echo "✓ Image removed"

# Configure shell alias for nvimd
shell-config:
    #!/usr/bin/env bash
    SCRIPT_PATH="{{config_dir}}/docker-nvim.sh"
    ALIAS_LINE="alias nvimd=\"$SCRIPT_PATH\""

    case "$SHELL" in
        */bash)
            RC_FILE="$HOME/.bashrc"
            if grep -q "alias nvimd=" "$RC_FILE" 2>/dev/null; then
                echo "✓ Alias 'nvimd' already exists in $RC_FILE"
            else
                echo "" >> "$RC_FILE"
                echo "# Podman Neovim alias" >> "$RC_FILE"
                echo "$ALIAS_LINE" >> "$RC_FILE"
                echo "✓ Added 'nvimd' alias to $RC_FILE"
                echo "  Run 'source $RC_FILE' or restart your shell"
            fi
            ;;
        */zsh)
            RC_FILE="$HOME/.zshrc"
            if grep -q "alias nvimd=" "$RC_FILE" 2>/dev/null; then
                echo "✓ Alias 'nvimd' already exists in $RC_FILE"
            else
                echo "" >> "$RC_FILE"
                echo "# Podman Neovim alias" >> "$RC_FILE"
                echo "$ALIAS_LINE" >> "$RC_FILE"
                echo "✓ Added 'nvimd' alias to $RC_FILE"
                echo "  Run 'source $RC_FILE' or restart your shell"
            fi
            ;;
        */fish)
            RC_FILE="$HOME/.config/fish/config.fish"
            mkdir -p "$(dirname "$RC_FILE")"
            if grep -q "alias nvimd" "$RC_FILE" 2>/dev/null; then
                echo "✓ Alias 'nvimd' already exists in $RC_FILE"
            else
                echo "" >> "$RC_FILE"
                echo "# Podman Neovim alias" >> "$RC_FILE"
                echo "alias nvimd \"$SCRIPT_PATH\"" >> "$RC_FILE"
                echo "✓ Added 'nvimd' alias to $RC_FILE"
                echo "  Run 'source $RC_FILE' or restart your shell"
            fi
            ;;
        *)
            echo "Shell '$SHELL' not supported for automatic configuration."
            echo "Please add the following alias manually to your shell config:"
            echo ""
            echo "  $ALIAS_LINE"
            ;;
    esac
