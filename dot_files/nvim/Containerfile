# syntax=docker/dockerfile:1

# Neovim Development Environment for Distrobox
# Pre-built image with all LSPs, formatters, linters, and tools
#
# Build: podman build -t nvim-dev .
# Use:   distrobox create --name nvim-dev --image localhost/nvim-dev

FROM registry.fedoraproject.org/fedora-toolbox:43

# =============================================================================
# LAYER 1: System packages
# Cache mount ensures RPM downloads persist across layer-busting rebuilds
# =============================================================================
RUN --mount=type=cache,target=/var/cache/dnf \
    dnf update -y && dnf install -y \
    # Build essentials
    gcc \
    gcc-c++ \
    make \
    cmake \
    automake \
    autoconf \
    libtool \
    # Development tools
    git \
    curl \
    wget \
    unzip \
    zip \
    tar \
    gzip \
    xz \
    bzip2 \
    # Libraries needed by various tools
    openssl-devel \
    readline-devel \
    zlib-devel \
    libffi-devel \
    ncurses-devel \
    sqlite-devel \
    bzip2-devel \
    xz-devel \
    # Utilities
    procps-ng \
    findutils \
    which \
    file \
    # Clipboard support
    xclip \
    xsel \
    wl-clipboard \
    # For Neovim
    gettext \
    # Locale support
    langpacks-en \
    glibc-langpack-en

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# =============================================================================
# LAYER 2: Homebrew installation with non-root user
# =============================================================================
RUN useradd -m -s /bin/bash -u 1001 linuxbrew \
    && git clone https://github.com/Homebrew/brew /home/linuxbrew/.linuxbrew/Homebrew \
    && mkdir -p /home/linuxbrew/.linuxbrew/bin \
    && ln -s ../Homebrew/bin/brew /home/linuxbrew/.linuxbrew/bin/ \
    && chown -R linuxbrew:linuxbrew /home/linuxbrew

ENV PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:${PATH}"
ENV HOMEBREW_NO_AUTO_UPDATE=1
ENV HOMEBREW_NO_ANALYTICS=1
ENV HOMEBREW_CACHE="/home/linuxbrew/.cache/Homebrew"

# Switch to linuxbrew user for all brew operations
USER linuxbrew
WORKDIR /home/linuxbrew

# Update Homebrew
RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew update

# =============================================================================
# LAYER 3: Core tools via Homebrew
# =============================================================================
RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew install \
    neovim \
    ripgrep \
    fd \
    fzf \
    tree-sitter \
    lazygit \
    gh \
    delta \
    jq \
    yq \
    bat \
    eza \
    just

# =============================================================================
# LAYER 4: Languages via Homebrew
# =============================================================================
RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew install \
    go \
    python@3.12 \
    node \
    ruby \
    lua \
    luarocks

# =============================================================================
# LAYER 5: Formatters and linters via Homebrew
# =============================================================================
RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew install \
    stylua \
    prettier \
    shfmt \
    shellcheck \
    hadolint \
    lua-language-server

# =============================================================================
# LAYER 6: Infrastructure tools via Homebrew
# =============================================================================
RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew install \
    terraform \
    tflint \
    helm \
    sqlfluff \
    fish

# =============================================================================
# LAYER 7: Rust toolchain (as linuxbrew user)
# =============================================================================
ENV CARGO_HOME="/home/linuxbrew/.cargo"
ENV RUSTUP_HOME="/home/linuxbrew/.rustup"
ENV PATH="${CARGO_HOME}/bin:${PATH}"

RUN --mount=type=cache,target=/home/linuxbrew/.cache/Homebrew,uid=1001,gid=1001 \
    brew install rustup-init \
    && rustup-init -y --default-toolchain stable \
    && . ${CARGO_HOME}/env \
    && rustup component add rustfmt clippy rust-analyzer

# =============================================================================
# LAYER 8: Go tools (as linuxbrew user)
# Pre-create GOPATH so the cache mount doesn't leave parents root-owned
# =============================================================================
ENV GOPATH="/home/linuxbrew/go"
ENV PATH="${GOPATH}/bin:${PATH}"

RUN mkdir -p ${GOPATH}/bin ${GOPATH}/pkg/mod/cache

RUN --mount=type=cache,target=/home/linuxbrew/go/pkg/mod/cache,uid=1001,gid=1001 \
    go install golang.org/x/tools/gopls@latest \
    && go install github.com/go-delve/delve/cmd/dlv@latest \
    && go install mvdan.cc/gofumpt@latest \
    && go install golang.org/x/tools/cmd/goimports@latest \
    && go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# =============================================================================
# LAYER 9: Python tools (as linuxbrew user, using brew's python)
# =============================================================================
RUN --mount=type=cache,target=/home/linuxbrew/.cache/pip,uid=1001,gid=1001 \
    pip3 install --break-system-packages \
    pynvim \
    ruff \
    black \
    isort \
    debugpy

# =============================================================================
# LAYER 10: Node.js/npm tools (as linuxbrew user)
# Pre-create .npm so the cache mount doesn't leave parent root-owned
# =============================================================================
ENV NPM_CONFIG_PREFIX="/home/linuxbrew/.npm-global"
ENV PATH="${NPM_CONFIG_PREFIX}/bin:${PATH}"

RUN mkdir -p /home/linuxbrew/.npm ${NPM_CONFIG_PREFIX}

RUN --mount=type=cache,target=/home/linuxbrew/.npm/_cacache,uid=1001,gid=1001 \
    npm install -g \
    neovim \
    typescript \
    typescript-language-server \
    @vtsls/language-server \
    eslint \
    eslint_d \
    @eslint/config-array \
    bash-language-server \
    dockerfile-language-server-nodejs \
    yaml-language-server \
    markdownlint-cli2 \
    markdown-toc \
    @tailwindcss/language-server \
    pyright \
    tree-sitter-cli \
    @mermaid-js/mermaid-cli

# Switch back to root for system-level operations
USER root
WORKDIR /

# =============================================================================
# LAYER 11: Terminal compatibility
# =============================================================================
RUN curl -fsSL https://raw.githubusercontent.com/ghostty-org/ghostty/main/src/terminfo/ghostty.terminfo \
    | tic -x -o /etc/terminfo -

# =============================================================================
# LAYER 12: Fix permissions for distrobox user mapping
# =============================================================================
# Distrobox maps the host user into the container, so we need to ensure
# all tool directories are accessible
RUN chmod -R 777 /home/linuxbrew

# Labels for GitHub Container Registry
LABEL org.opencontainers.image.source="https://github.com/binarypie/hypercube"
LABEL org.opencontainers.image.description="Neovim development environment with LSPs, formatters, and tools"
LABEL org.opencontainers.image.licenses="MIT"
